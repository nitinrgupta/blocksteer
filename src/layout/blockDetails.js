import React, { useEffect }  from 'react';
import { useParams, useHistory } from "react-router-dom";
import styled from 'styled-components/macro';
import { IconArrowLeft, textStyle, ToastHub, Toast } from '@aragon/ui';
import moment from 'moment';

// Redux
import { useDispatch, useSelector } from "react-redux";

// Actions
import { fetchBlock } from '../actions';

// Components Imports
import Transaction from '../components/transaction';
import Loader from '../components/loader';

// Utils
import { copyTextToClipboard } from '../utils';

// Styles
import { BlockCard, hoverBg } from '../styles/Common';


function BlockDetails() {
  let { id } = useParams();
  let history = useHistory();

  const { block, blockTransactions, loading } = useSelector(state => ({
    block: state.block,
    blockTransactions: state.blockTransactions.list,
    loading: state.blockTransactions.loading
  }));

  const dispatch = useDispatch();

  useEffect(() => {
    console.log('calling fetch blocks');
    dispatch(fetchBlock(id));
  }, [dispatch, id])  

  // Function to ge ot previous state using react router
  function goBack() {
    history.push("/");
  }

  return (
    <div>
      <BackButton onClick={() => goBack()}>
        <IconArrowLeft css={`margin-right: 5px;`} size="small" />
        <p css={`${textStyle("label2")};`}>Go Back</p>
      </BackButton>
      <BlockDetailsCard>
        <h1 css={`${textStyle("title1")};`}>Block #{block.number}</h1>
        <BlockMetaDetailsContainer>
          <BlockMetaDetails>
            <svg width="12" height="12" viewBox="0 0 25 25" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M2.20646 12.2732C2.26106 9.62381 3.33933 7.09847 5.21516 5.22671C6.15992 4.28195 7.25875 3.53777 8.48258 3.02033C9.75002 2.48545 11.0959 2.2122 12.4826 2.2122C13.8721 2.2122 15.218 2.48254 16.4825 3.02033C17.7064 3.53777 18.8052 4.28195 19.75 5.22671C20.0407 5.51741 20.311 5.82264 20.561 6.1395L19.1075 7.27612C19.0729 7.30291 19.0465 7.33892 19.0315 7.38002C19.0164 7.42112 19.0132 7.46564 19.0223 7.50846C19.0315 7.55128 19.0525 7.59065 19.083 7.62206C19.1135 7.65347 19.1522 7.67563 19.1947 7.686L23.7528 8.79937C23.8982 8.83425 24.0406 8.72379 24.0406 8.57553L24.0639 3.88079C24.0639 3.68603 23.8401 3.57556 23.6889 3.69765L22.2994 4.78486C20.0203 1.86918 16.4709 0 12.4855 0C5.66864 0 0.125072 5.46799 7.26914e-05 12.2616C-0.000703191 12.2926 0.00473872 12.3234 0.0160779 12.3523C0.0274171 12.3812 0.0444241 12.4076 0.0660967 12.4298C0.0877694 12.452 0.113669 12.4696 0.14227 12.4817C0.170871 12.4937 0.201594 12.4999 0.232629 12.4999H1.97681C2.1018 12.4999 2.20355 12.3982 2.20646 12.2732ZM24.7674 12.4999H23.0232C22.8982 12.4999 22.7935 12.6017 22.7906 12.7267C22.736 15.376 21.6578 17.9014 19.7819 19.7731C18.8458 20.7131 17.7362 21.4625 16.5145 21.9795C15.2471 22.5144 13.9012 22.7877 12.5145 22.7877C11.1279 22.7877 9.77909 22.5173 8.51456 21.9795C7.29289 21.4625 6.18322 20.7131 5.24714 19.7731C4.95644 19.4824 4.68609 19.1772 4.43609 18.8604L5.88667 17.7237C5.92129 17.6969 5.94765 17.6609 5.96272 17.6198C5.97779 17.5787 5.98095 17.5342 5.97184 17.4914C5.96273 17.4486 5.94172 17.4092 5.91122 17.3778C5.88073 17.3464 5.84199 17.3242 5.79946 17.3139L1.24134 16.2005C1.096 16.1656 0.953556 16.2761 0.953556 16.4243L0.9303 21.1249C0.9303 21.3196 1.15414 21.4301 1.3053 21.308L2.69482 20.2208C4.97969 23.1307 8.52909 24.9999 12.5145 24.9999C19.3314 24.9999 24.8749 19.5319 24.9999 12.7383C25.0007 12.7073 24.9953 12.6764 24.9839 12.6475C24.9726 12.6186 24.9556 12.5923 24.9339 12.5701C24.9122 12.5479 24.8863 12.5302 24.8577 12.5182C24.8291 12.5061 24.7984 12.4999 24.7674 12.4999Z" fill="black"/>
              <path d="M7.84314 17.6155C7.84314 17.015 8.32991 16.5283 8.93037 16.5283H15.8057C16.4061 16.5283 16.8929 17.015 16.8929 17.6155V17.6155C16.8929 18.216 16.4061 18.7027 15.8057 18.7027H8.93037C8.32991 18.7027 7.84314 18.216 7.84314 17.6155V17.6155ZM8.79626 12.6205C8.79626 12.0181 9.28462 11.5297 9.88705 11.5297H14.7606C15.363 11.5297 15.8513 12.0181 15.8513 12.6205V12.6205C15.8513 13.2229 15.363 13.7113 14.7606 13.7113H9.88705C9.28462 13.7113 8.79626 13.2229 8.79626 12.6205V12.6205ZM7.96105 7.73235C7.96105 7.12707 8.45173 6.6364 9.05701 6.6364H15.5218C16.1271 6.6364 16.6178 7.12707 16.6178 7.73235V7.73235C16.6178 8.33763 16.1271 8.8283 15.5218 8.8283H9.05701C8.45173 8.8283 7.96105 8.33763 7.96105 7.73235V7.73235Z" fill="black"/>
            </svg>
            <p>{block.transactions && block.transactions.length}  Transactions</p>
          </BlockMetaDetails>
          <BlockMetaDetails>
            <svg width="12" height="12" viewBox="0 0 23 23" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M22.2812 23H19.4062C19.2116 23 19.0431 22.9289 18.9009 22.7866C18.7586 22.6444 18.6875 22.4759 18.6875 22.2812V20.8438C18.6875 20.6491 18.7586 20.4806 18.9009 20.3384C19.0431 20.1961 19.2116 20.125 19.4062 20.125H20.125V19.4062C20.125 19.2116 20.1961 19.0431 20.3384 18.9009C20.4806 18.7586 20.6491 18.6875 20.8438 18.6875H22.2812C22.4759 18.6875 22.6444 18.7586 22.7866 18.9009C22.9289 19.0431 23 19.2116 23 19.4062V22.2812C23 22.4759 22.9289 22.6444 22.7866 22.7866C22.6444 22.9289 22.4759 23 22.2812 23ZM22.2812 17.25H20.8438C20.6491 17.25 20.4806 17.1789 20.3384 17.0366C20.1961 16.8944 20.125 16.7259 20.125 16.5312V15.0938C20.125 14.8991 20.1961 14.7306 20.3384 14.5884C20.4806 14.4461 20.6491 14.375 20.8438 14.375H22.2812C22.4759 14.375 22.6444 14.4461 22.7866 14.5884C22.9289 14.7306 23 14.8991 23 15.0938V16.5312C23 16.7259 22.9289 16.8944 22.7866 17.0366C22.6444 17.1789 22.4759 17.25 22.2812 17.25ZM22.2812 12.9375H20.8438C20.6491 12.9375 20.4806 12.8664 20.3384 12.7241C20.1961 12.5819 20.125 12.4134 20.125 12.2188V10.7812C20.125 10.5866 20.1961 10.4181 20.3384 10.2759C20.4806 10.1336 20.6491 10.0625 20.8438 10.0625H22.2812C22.4759 10.0625 22.6444 10.1336 22.7866 10.2759C22.9289 10.4181 23 10.5866 23 10.7812V12.2188C23 12.4134 22.9289 12.5819 22.7866 12.7241C22.6444 12.8664 22.4759 12.9375 22.2812 12.9375ZM22.2812 8.625H20.8438C20.6491 8.625 20.4806 8.55387 20.3384 8.41162C20.1961 8.26937 20.125 8.10091 20.125 7.90625V6.46875C20.125 6.27409 20.1961 6.10563 20.3384 5.96338C20.4806 5.82113 20.6491 5.75 20.8438 5.75H22.2812C22.4759 5.75 22.6444 5.82113 22.7866 5.96338C22.9289 6.10563 23 6.27409 23 6.46875V7.90625C23 8.10091 22.9289 8.26937 22.7866 8.41162C22.6444 8.55387 22.4759 8.625 22.2812 8.625ZM22.2812 4.3125H20.8438C20.6491 4.3125 20.4806 4.24137 20.3384 4.09912C20.1961 3.95687 20.125 3.78841 20.125 3.59375V2.875H19.4062C19.2116 2.875 19.0431 2.80387 18.9009 2.66162C18.7586 2.51937 18.6875 2.35091 18.6875 2.15625V0.71875C18.6875 0.524089 18.7586 0.355632 18.9009 0.213379C19.0431 0.0711263 19.2116 0 19.4062 0H22.2812C22.4759 0 22.6444 0.0711263 22.7866 0.213379C22.9289 0.355632 23 0.524089 23 0.71875V3.59375C23 3.78841 22.9289 3.95687 22.7866 4.09912C22.6444 4.24137 22.4759 4.3125 22.2812 4.3125ZM16.5312 23H15.0938C14.8991 23 14.7306 22.9289 14.5884 22.7866C14.4461 22.6444 14.375 22.4759 14.375 22.2812V20.8438C14.375 20.6491 14.4461 20.4806 14.5884 20.3384C14.7306 20.1961 14.8991 20.125 15.0938 20.125H16.5312C16.7259 20.125 16.8944 20.1961 17.0366 20.3384C17.1789 20.4806 17.25 20.6491 17.25 20.8438V22.2812C17.25 22.4759 17.1789 22.6444 17.0366 22.7866C16.8944 22.9289 16.7259 23 16.5312 23ZM16.5312 2.875H15.0938C14.8991 2.875 14.7306 2.80387 14.5884 2.66162C14.4461 2.51937 14.375 2.35091 14.375 2.15625V0.71875C14.375 0.524089 14.4461 0.355632 14.5884 0.213379C14.7306 0.0711263 14.8991 0 15.0938 0H16.5312C16.7259 0 16.8944 0.0711263 17.0366 0.213379C17.1789 0.355632 17.25 0.524089 17.25 0.71875V2.15625C17.25 2.35091 17.1789 2.51937 17.0366 2.66162C16.8944 2.80387 16.7259 2.875 16.5312 2.875ZM12.2188 23H10.7812C10.5866 23 10.4181 22.9289 10.2759 22.7866C10.1336 22.6444 10.0625 22.4759 10.0625 22.2812V20.8438C10.0625 20.6491 10.1336 20.4806 10.2759 20.3384C10.4181 20.1961 10.5866 20.125 10.7812 20.125H12.2188C12.4134 20.125 12.5819 20.1961 12.7241 20.3384C12.8664 20.4806 12.9375 20.6491 12.9375 20.8438V22.2812C12.9375 22.4759 12.8664 22.6444 12.7241 22.7866C12.5819 22.9289 12.4134 23 12.2188 23ZM12.2188 12.9375H0.71875C0.524089 12.9375 0.355632 12.8664 0.213379 12.7241C0.0711263 12.5819 0 12.4134 0 12.2188V0.71875C0 0.524089 0.0711263 0.355632 0.213379 0.213379C0.355632 0.0711263 0.524089 0 0.71875 0H12.2188C12.4134 0 12.5819 0.0711263 12.7241 0.213379C12.8664 0.355632 12.9375 0.524089 12.9375 0.71875V12.2188C12.9375 12.4134 12.8664 12.5819 12.7241 12.7241C12.5819 12.8664 12.4134 12.9375 12.2188 12.9375ZM0.71875 14.375H2.15625C2.35091 14.375 2.51937 14.4461 2.66162 14.5884C2.80387 14.7306 2.875 14.8991 2.875 15.0938V16.5312C2.875 16.7259 2.80387 16.8944 2.66162 17.0366C2.51937 17.1789 2.35091 17.25 2.15625 17.25H0.71875C0.524089 17.25 0.355632 17.1789 0.213379 17.0366C0.0711263 16.8944 0 16.7259 0 16.5312V15.0938C0 14.8991 0.0711263 14.7306 0.213379 14.5884C0.355632 14.4461 0.524089 14.375 0.71875 14.375ZM0.71875 18.6875H2.15625C2.35091 18.6875 2.51937 18.7586 2.66162 18.9009C2.80387 19.0431 2.875 19.2116 2.875 19.4062V20.125H3.59375C3.78841 20.125 3.95687 20.1961 4.09912 20.3384C4.24137 20.4806 4.3125 20.6491 4.3125 20.8438V22.2812C4.3125 22.4759 4.24137 22.6444 4.09912 22.7866C3.95687 22.9289 3.78841 23 3.59375 23H0.71875C0.524089 23 0.355632 22.9289 0.213379 22.7866C0.0711263 22.6444 0 22.4759 0 22.2812V19.4062C0 19.2116 0.0711263 19.0431 0.213379 18.9009C0.355632 18.7586 0.524089 18.6875 0.71875 18.6875ZM6.46875 20.125H7.90625C8.10091 20.125 8.26937 20.1961 8.41162 20.3384C8.55387 20.4806 8.625 20.6491 8.625 20.8438V22.2812C8.625 22.4759 8.55387 22.6444 8.41162 22.7866C8.26937 22.9289 8.10091 23 7.90625 23H6.46875C6.27409 23 6.10563 22.9289 5.96338 22.7866C5.82113 22.6444 5.75 22.4759 5.75 22.2812V20.8438C5.75 20.6491 5.82113 20.4806 5.96338 20.3384C6.10563 20.1961 6.27409 20.125 6.46875 20.125Z" fill="black"/>
            </svg>
            <p>{block.size}  bytes</p>
          </BlockMetaDetails>
          <BlockMetaDetails>
            <svg width="12" height="12" viewBox="0 0 25 25" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M21.339 3.66097C20.181 2.49657 18.8035 1.57345 17.2863 0.945051C15.769 0.316649 14.1422 -0.00455038 12.5 4.86981e-05C10.8578 -0.00446409 9.23102 0.316774 7.7138 0.945171C6.19658 1.57357 4.81906 2.49664 3.66097 3.66097C2.49664 4.81906 1.57357 6.19658 0.94517 7.7138C0.316773 9.23102 -0.00446589 10.8578 4.68945e-05 12.5C4.68945e-05 15.8391 1.30004 18.9781 3.66097 21.339C4.81906 22.5034 6.19658 23.4264 7.7138 24.0548C9.23102 24.6832 10.8578 25.0045 12.5 25C14.1422 25.0045 15.769 24.6832 17.2862 24.0548C18.8034 23.4264 20.1809 22.5034 21.339 21.339C22.5034 20.1809 23.4264 18.8034 24.0548 17.2862C24.6832 15.769 25.0045 14.1422 25 12.5C25.0045 10.8578 24.6832 9.23102 24.0548 7.7138C23.4264 6.19658 22.5034 4.81906 21.339 3.66097ZM12.5 22.9797C9.72164 22.9763 7.05802 21.8712 5.09342 19.9066C3.12883 17.942 2.02366 15.2784 2.02035 12.5C2.02366 9.72164 3.12883 7.05802 5.09342 5.09343C7.05802 3.12883 9.72164 2.02366 12.5 2.02035C15.2784 2.02366 17.942 3.12883 19.9066 5.09343C21.8712 7.05802 22.9763 9.72164 22.9797 12.5C22.9763 15.2784 21.8712 17.942 19.9066 19.9066C17.942 21.8712 15.2784 22.9763 12.5 22.9797Z" fill="black"/>
              <path d="M16.6609 15.2344L13.5093 12.0813V5.60628C13.5093 5.33857 13.403 5.08184 13.2137 4.89254C13.0244 4.70325 12.7677 4.59691 12.5 4.59691C12.2323 4.59691 11.9755 4.70325 11.7862 4.89254C11.5969 5.08184 11.4906 5.33857 11.4906 5.60628V12.5C11.4906 12.7672 11.5969 13.025 11.7859 13.2141L15.2328 16.6609C15.3263 16.7551 15.4376 16.8299 15.5601 16.8809C15.6827 16.9319 15.8141 16.9582 15.9468 16.9582C16.0796 16.9582 16.211 16.9319 16.3336 16.8809C16.4561 16.8299 16.5674 16.7551 16.6609 16.6609C16.7547 16.5672 16.8292 16.4559 16.8799 16.3333C16.9307 16.2108 16.9569 16.0795 16.9569 15.9469C16.9569 15.8142 16.9307 15.6829 16.8799 15.5604C16.8292 15.4379 16.7547 15.3265 16.6609 15.2328V15.2344Z" fill="black"/>
            </svg>
            <p>{moment.unix(block.timestamp).format('DD/MM/YYYY hh:mm a')}</p>
          </BlockMetaDetails>
        </BlockMetaDetailsContainer>
        <Divider />
        <BlockMoreDetails css={`margin-bottom: 25px;`} hoverEnabled>
          <label>Hash</label>
          <ToastHub timeout={500}>
            <Toast>
              {toast => (
                <Hash onClick={() => copyTextToClipboard(block.hash) ? toast("Block Hash copied to clipboard") : toast("Failed to copy the block hash. Please try again.")}>{block.hash}</Hash>
              )}
            </Toast>
          </ToastHub>
        </BlockMoreDetails>
        <BlockMoreDetails css={`margin-bottom: 25px;`} hoverEnabled>
          <label>Mined By</label>
          <ToastHub timeout={500}>
            <Toast>
              {toast => (
                <Hash onClick={() => copyTextToClipboard(block.miner) ? toast("Miner address copied to clipboard") : toast("Failed to copy the miner address. Please try again.")}>{block.miner}</Hash>
              )}
            </Toast>
          </ToastHub>
        </BlockMoreDetails>
        <BlockMoreDetails>
          <label>Gas Used</label>
          <p css={`padding: 5px;`}>{(block.gasUsed/block.gasLimit * 100).toFixed(2) + '%'}</p>
        </BlockMoreDetails>
      </BlockDetailsCard>

      <TransactionsHeader>
        <svg width="23" height="23" viewBox="0 0 25 25" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M2.20646 12.2732C2.26106 9.62381 3.33933 7.09847 5.21516 5.22671C6.15992 4.28195 7.25875 3.53777 8.48258 3.02033C9.75002 2.48545 11.0959 2.2122 12.4826 2.2122C13.8721 2.2122 15.218 2.48254 16.4825 3.02033C17.7064 3.53777 18.8052 4.28195 19.75 5.22671C20.0407 5.51741 20.311 5.82264 20.561 6.1395L19.1075 7.27612C19.0729 7.30291 19.0465 7.33892 19.0315 7.38002C19.0164 7.42112 19.0132 7.46564 19.0223 7.50846C19.0315 7.55128 19.0525 7.59065 19.083 7.62206C19.1135 7.65347 19.1522 7.67563 19.1947 7.686L23.7528 8.79937C23.8982 8.83425 24.0406 8.72379 24.0406 8.57553L24.0639 3.88079C24.0639 3.68603 23.8401 3.57556 23.6889 3.69765L22.2994 4.78486C20.0203 1.86918 16.4709 0 12.4855 0C5.66864 0 0.125072 5.46799 7.26914e-05 12.2616C-0.000703191 12.2926 0.00473872 12.3234 0.0160779 12.3523C0.0274171 12.3812 0.0444241 12.4076 0.0660967 12.4298C0.0877694 12.452 0.113669 12.4696 0.14227 12.4817C0.170871 12.4937 0.201594 12.4999 0.232629 12.4999H1.97681C2.1018 12.4999 2.20355 12.3982 2.20646 12.2732ZM24.7674 12.4999H23.0232C22.8982 12.4999 22.7935 12.6017 22.7906 12.7267C22.736 15.376 21.6578 17.9014 19.7819 19.7731C18.8458 20.7131 17.7362 21.4625 16.5145 21.9795C15.2471 22.5144 13.9012 22.7877 12.5145 22.7877C11.1279 22.7877 9.77909 22.5173 8.51456 21.9795C7.29289 21.4625 6.18322 20.7131 5.24714 19.7731C4.95644 19.4824 4.68609 19.1772 4.43609 18.8604L5.88667 17.7237C5.92129 17.6969 5.94765 17.6609 5.96272 17.6198C5.97779 17.5787 5.98095 17.5342 5.97184 17.4914C5.96273 17.4486 5.94172 17.4092 5.91122 17.3778C5.88073 17.3464 5.84199 17.3242 5.79946 17.3139L1.24134 16.2005C1.096 16.1656 0.953556 16.2761 0.953556 16.4243L0.9303 21.1249C0.9303 21.3196 1.15414 21.4301 1.3053 21.308L2.69482 20.2208C4.97969 23.1307 8.52909 24.9999 12.5145 24.9999C19.3314 24.9999 24.8749 19.5319 24.9999 12.7383C25.0007 12.7073 24.9953 12.6764 24.9839 12.6475C24.9726 12.6186 24.9556 12.5923 24.9339 12.5701C24.9122 12.5479 24.8863 12.5302 24.8577 12.5182C24.8291 12.5061 24.7984 12.4999 24.7674 12.4999Z" fill="black"/>
          <path d="M7.84314 17.6155C7.84314 17.015 8.32991 16.5283 8.93037 16.5283H15.8057C16.4061 16.5283 16.8929 17.015 16.8929 17.6155V17.6155C16.8929 18.216 16.4061 18.7027 15.8057 18.7027H8.93037C8.32991 18.7027 7.84314 18.216 7.84314 17.6155V17.6155ZM8.79626 12.6205C8.79626 12.0181 9.28462 11.5297 9.88705 11.5297H14.7606C15.363 11.5297 15.8513 12.0181 15.8513 12.6205V12.6205C15.8513 13.2229 15.363 13.7113 14.7606 13.7113H9.88705C9.28462 13.7113 8.79626 13.2229 8.79626 12.6205V12.6205ZM7.96105 7.73235C7.96105 7.12707 8.45173 6.6364 9.05701 6.6364H15.5218C16.1271 6.6364 16.6178 7.12707 16.6178 7.73235V7.73235C16.6178 8.33763 16.1271 8.8283 15.5218 8.8283H9.05701C8.45173 8.8283 7.96105 8.33763 7.96105 7.73235V7.73235Z" fill="black"/>
        </svg>
        <h1 css={`${textStyle("title2")};`}>Transactions</h1>
      </TransactionsHeader>
      {!loading && blockTransactions.length > 0 ? (
        <TransactionsContainer>
          {blockTransactions.map((transaction) =>
            <Transaction {...transaction} key={transaction.hash}/>
          )}
        </TransactionsContainer>
        ) : (
          <Loader text="Fetching the latest Transactions from this block... Hang Tight!" />
        )
      }
    </div>
  );
}

const TransactionsContainer = styled.div`
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
`;

const TransactionsHeader = styled.div`
  display: inline-flex;
  align-items: center;
  margin: 25px 0 15px 0;
  
  svg {
    margin-right: 10px;
    opacity: 0.2;
    margin-bottom: 5px;
  }
`;

const BackButton = styled.button`
  display: inline-flex;
  background: none;
  border: none;
  color: white;
  cursor: pointer;
  padding-left: 0;
  align-items: center;
  transition: all .2s ease-in-out;

  &:hover {
    opacity: 0.8;
  }
`;

const BlockDetailsCard = styled(BlockCard)`
  padding: 25px;
`;

const BlockMetaDetailsContainer = styled.div`
  display: inline-flex;
  width: 100%;
`;

const BlockMetaDetails = styled.div`
  display: flex;
  align-items: center;
  margin-right: 35px;
  
  p {
    ${textStyle("label1")};
  }

  svg {
    margin-right: 5px;
    opacity: 0.3;
    margin-bottom: 2px;
  }
`;

const Divider = styled.div`
  border-bottom: 1px solid #0e1e241f;
  margin: 25px 0;
`;

const BlockMoreDetails = styled.div`
  display: flex;
  width: 100%;
  margin-bottom: 25px;
  align-items: baseline;

  label {
    width: 12%;
    ${textStyle("label1")};
  }
`;

const Hash = styled.p`
  cursor: pointer;
  ${textStyle("address1")};
  padding: 5px;
  border-radius: 5px;

  &:hover {
    background-color: ${hoverBg};
  }
`;


export default BlockDetails;
